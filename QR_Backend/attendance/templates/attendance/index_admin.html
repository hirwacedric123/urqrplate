{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - QRPlate</title>
    <link rel="stylesheet" href="{% static 'assets/css/index.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'assets/images/logo_alu.png' %}">
</head>

<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-content">
            <div class="nav-left">
                <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <img src="{% static 'assets/images/alualu.png' %}" class="nav-logo" alt="ALU Logo">
                <h1 class="nav-title">Admin Dashboard</h1>
        </div>
            <div class="nav-right">
                <a href="{% url 'scan_page' %}" class="nav-btn scan-btn">
                    <i class="fas fa-qrcode"></i>
                    <span>Scan QR</span>
                </a>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
            </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <ul class="sidebar-menu">
                    <li class="menu-item active" onclick="showSection('dashboard')">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </li>
                    <li class="menu-item" onclick="showSection('students')">
                        <i class="fas fa-users"></i>
                        <span>Students</span>
                    </li>
                    <li class="menu-item">
                        <a href="{% url 'scan_page' %}" class="menu-link">
                            <i class="fas fa-qrcode"></i>
                            <span>Scan QR</span>
                        </a>
                    </li>
                    <li class="menu-item" onclick="printData()">
                        <i class="fas fa-file-export"></i>
                        <span>Export</span>
                    </li>
                    <li class="menu-item" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
                <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Attendance Summary
                    </h2>
                    <div class="date-filter">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="text" id="pickerdate-summary" placeholder="Select Date" class="date-input">
                        </div>
                        </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #0369A1, #0891B2);">
                            <i class="fas fa-user-graduate"></i>
                            </div>
                        <div class="stat-content">
                            <h3 class="stat-label">Total Registered</h3>
                            <p class="stat-value" id="totalStudents">{{ total_students }}</p>
                            </div>
                            </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-check-circle"></i>
                            </div>
                        <div class="stat-content">
                            <h3 class="stat-label">Total Attended</h3>
                            <p class="stat-value" id="totalAttended">{{ total_attended }}</p>
                            </div>
                        </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #06B6D4, #0891B2);">
                            <i class="fas fa-money-check-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-label">Paid Attended</h3>
                            <p class="stat-value" id="PaidAttended">{{ paid_attended }}</p>
                    </div>
                </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-label">Paid Absent</h3>
                            <p class="stat-value" id="PaidAbsent">{{ paid_absent }}</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-label">Unpaid Attended</h3>
                            <p class="stat-value" id="UnpaidAttended">{{ unpaid_attended }}</p>
                        </div>
                    </div>
                </div>
            </section>

                <!-- Students Section -->
            <section id="students" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-users"></i>
                        Student Management
                    </h2>
                        </div>

                <div class="filters-bar">
                    <div class="filter-buttons">
                        <button class="filter-btn active" id="button_all" onclick="showAll()">
                            <i class="fas fa-list"></i>
                            All Students
                        </button>
                        <button class="filter-btn" id="button_present" onclick="showPresent()">
                            <i class="fas fa-check"></i>
                            Present
                        </button>
                        <button class="filter-btn" id="button_absent" onclick="showAbsent()">
                            <i class="fas fa-times"></i>
                            Absent
                        </button>
                        <button class="filter-btn" id="button_paid" onclick="showPaid()">
                            <i class="fas fa-dollar-sign"></i>
                            Paid Only
                        </button>
                        <button class="filter-btn" id="button_paid_absent" onclick="showPaidAbsent()">
                            <i class="fas fa-exclamation"></i>
                            Paid Absent
                        </button>
                        <button class="filter-btn" id="button_unpaid_present" onclick="showUnpaidPresent()">
                            <i class="fas fa-user-check"></i>
                            Unpaid Present
                        </button>
                            </div>
                </div>

                <div class="search-bar">
                    <div class="search-group">
                        <div class="date-filter-group">
                            <i class="fas fa-calendar"></i>
                            <input type="text" id="datePicker" placeholder="Select Date" class="date-input">
                        </div>
                        <div class="search-group-input">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search" placeholder="Search by name or phone number..." 
                                    oninput="filterTable()">
                        </div>
                            </div>
                            <div id="search-results"></div>
                        </div>

                <div class="table-wrapper">
                    <table class="data-table">
                        <colgroup>
                            <col style="width: 60px;">
                            <col style="width: 200px;">
                            <col style="width: 250px;">
                            <col style="width: 130px;">
                            <col style="width: 100px;">
                            <col style="width: 100px;">
                            <col style="width: 150px;">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Scholar</th>
                                <th>Paid</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table">
                            <!-- Rows will be dynamically added here -->
                        </tbody>
                    </table>
                        </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i>
                        Settings & Profile
                    </h2>
                </div>

                <div class="settings-grid">
                    <div class="settings-card" onclick="toggleModal('updateProfileModal')">
                        <div class="settings-icon">
                            <i class="fas fa-user-edit"></i>
                        </div>
                                <h3>Update Profile</h3>
                        <p>Manage your personal information</p>
                            </div>

                    <div class="settings-card" onclick="toggleModal('raiseIssueModal')">
                        <div class="settings-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        <h3>Technical Support</h3>
                        <p>Report issues or get help</p>
                        </div>
                    </div>

                <!-- Update Profile Modal -->
                    <div id="updateProfileModal" class="modal">
                        <div class="modal-content">
                        <div class="modal-header">
                                <h2>Update Your Profile</h2>
                            <button class="modal-close" onclick="toggleModal('updateProfileModal')">
                                <i class="fas fa-times"></i>
                            </button>
                            </div>
                        <form method="POST" action="{% url 'admin_dashboard' %}" class="modal-form">
                                    {% csrf_token %}
                            <div class="form-group">
                                    <label for="student_id">Student ID:</label>
                                    <input type="text" id="student_id" name="student_id"
                                        value="{{ form.student_id.value }}" disabled>
                            </div>
                            <div class="form-group">
                                    <label for="email">Email Address:</label>
                                    <input type="email" id="email" name="email" value="{{ form.email.value }}" required>
                            </div>
                            <div class="form-group">
                                    <label for="phone">Phone Number:</label>
                                    <input type="text" id="phone" name="phone" value="{{ form.phone.value }}" required>
                            </div>
                            <div class="form-group">
                                    <label for="first_name">First Name:</label>
                                    <input type="text" id="first_name" name="first_name"
                                        value="{{ form.first_name.value }}" required>
                            </div>
                            <div class="form-group">
                                    <label for="last_name">Last Name:</label>
                                    <input type="text" id="last_name" name="last_name"
                                        value="{{ form.last_name.value }}" required>
                            </div>
                            <div class="form-group checkbox-group">
                                <label for="is_scholar">
                                    <input type="checkbox" id="is_scholar" name="is_scholar" 
                                           {% if form.is_scholar.value %}checked{% endif %}>
                                    <span>I am a scholar student</span>
                                </label>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </form>
                            {% if messages %}
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                <!-- Raise Issue Modal -->
                <div id="raiseIssueModal" class="modal">
                        <div class="modal-content">
                        <div class="modal-header">
                                <h2>Raise an Issue</h2>
                            <button class="modal-close" onclick="toggleModal('raiseIssueModal')">
                                <i class="fas fa-times"></i>
                            </button>
                            </div>
                        <form method="POST" action="{% url 'report_issue' %}" class="modal-form">
                                    {% csrf_token %}
                            <div class="form-group">
                                <label for="id_title">Title</label>
                                        {{ issue_form.title }}
                                    </div>
                            <div class="form-group">
                                <label for="id_description">Description</label>
                                        {{ issue_form.description }}
                                    </div>
                            <div class="form-group">
                                        <label for="id_priority">Priority</label>
                                        {{ issue_form.priority }}
                                    </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane"></i>
                                Submit Issue
                            </button>
                                </form>
                            {% if messages %}
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
            </div>
        </div>
    </section>
        </main>
    </div>

    {{ redirect_to_login_immediately }}

    <script>
        // Data passed from the backend
        const students = JSON.parse('{{ students_json|safe }}');

        // DOM Elements
        const tableBody = document.getElementById('attendance-table');

        function renderTable(data) {
            tableBody.innerHTML = '';
            data.forEach((student, index) => {
                const row = document.createElement('tr');
                row.style.opacity = '0';
                row.style.transform = 'translateY(20px)';
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td><strong>${student.name}</strong></td>
                    <td>${student.email}</td>
                    <td>${student.phone}</td>
                    <td><span class="badge ${student.scholar === 'Yes' ? 'badge-success' : 'badge-secondary'}">${student.scholar}</span></td>
                    <td>
                        <button class="toggle-btn ${student.paid === 'Yes' ? '' : 'no'}" onclick="togglePaid(${student.id})">
                            ${student.paid}
                        </button>
                    </td>
                    <td>
                        <span class="status-badge ${student.present === 'Present' ? 'status-present' : 'status-absent'}">
                            <i class="fas ${student.present === 'Present' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ${student.present}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
                setTimeout(() => {
                    row.style.transition = 'all 0.3s ease-out';
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, index * 20);
            });
        }

        // Initialize table
        renderTable(students);

        // Section switching
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (sectionId === 'dashboard') {
                updateDashboardStats();
            }
        }

        // Filter functions
        function showAll() {
            renderTable(students);
            setActiveButton('button_all');
        }

        function showPresent() {
            renderTable(students.filter(student => student.present === 'Present'));
            setActiveButton('button_present');
        }

        function showAbsent() {
            renderTable(students.filter(student => student.present === 'Absent'));
            setActiveButton('button_absent');
        }

        function showPaid() {
            renderTable(students.filter(student => student.paid === 'Yes'));
            setActiveButton('button_paid');
        }

        function showPaidAbsent() {
            renderTable(students.filter(student => student.paid === 'Yes' && student.present === 'Absent'));
            setActiveButton('button_paid_absent');
        }

        function showUnpaidPresent() {
            renderTable(students.filter(student => student.paid === 'No' && student.present === 'Present'));
            setActiveButton('button_unpaid_present');
        }

        function setActiveButton(buttonId) {
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(buttonId).classList.add('active');
        }

        // Toggle paid status
        function togglePaid(id) {
            const student = students.find(s => s.id === id);
            if (student) {
                const newStatus = student.paid === 'Yes' ? 'No' : 'Yes';
                fetch('api/toggle-payment-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        id: student.id,
                        paid: newStatus,
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            student.paid = newStatus;
                            renderTable(students);
                        showToast(`Payment status updated to ${newStatus}`, 'success');
                        } else {
                        showToast(data.message || 'Failed to update payment status', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    showToast('An error occurred while updating the payment status', 'error');
                    });
            }
        }

        // Search functionality
        function filterTable() {
            const query = document.getElementById('search').value.toLowerCase();
            const rows = document.querySelectorAll('#attendance-table tr');
            rows.forEach(row => {
                const name = row.children[1].textContent.toLowerCase();
                const phone = row.children[3].textContent.toLowerCase();
                if (name.includes(query) || phone.includes(query)) {
                    row.style.display = '';
            } else {
                    row.style.display = 'none';
                }
            });
        }

        function searchStudent() {
            const query = document.getElementById("search").value.trim();
            const resultsContainer = document.getElementById("search-results");
            if (query === "") {
                resultsContainer.innerHTML = "";
                return;
            }
            fetch(`/admin_dashboard/search-students/?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = data.results.length > 0
                        ? data.results.map(student => `<p>${student.name} - ${student.phone}</p>`).join("")
                        : "<p>No results found.</p>";
                })
                .catch(error => {
                    console.error("Error:", error);
                    resultsContainer.innerHTML = "<p>Error fetching search results.</p>";
                });
        }

        // Date picker initialization
        const datePicker = flatpickr("#datePicker", {
            defaultDate: "today",
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                loadAttendanceData(dateStr);
            }
        });

        const summaryDatePicker = flatpickr("#pickerdate-summary", {
            defaultDate: "today",
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                AttandanceSummary(dateStr);
            }
        });

        function loadAttendanceData(dateStr) {
            fetch(`api/get-attendance-data/?date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTable(data.students);
                } else {
                        showToast("No attendance records found for the selected date.", 'info');
                    }
                })
                .catch(error => {
                    console.error("Error fetching attendance data:", error);
                    showToast("An error occurred while fetching attendance data.", 'error');
                });
        }

        function AttandanceSummary(formattedDate) {
            var content = formattedDate;
            var csrftoken = getCookie('csrftoken');
            fetch('/admin_dashboard/api/get-attendance-summary/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
                .then(data => {
                document.getElementById('totalStudents').textContent = data.totalStudents;
                document.getElementById('totalAttended').textContent = data.totalAttended;
                document.getElementById('PaidAttended').textContent = data.PaidAttended;
                document.getElementById('PaidAbsent').textContent = data.PaidAbsent;
                document.getElementById('UnpaidAttended').textContent = data.UnpaidAttended;
                })
                .catch(error => {
                    console.error('Error:', error);
            });
        }

        // Initialize summary on load
        window.onload = function() {
            const today = new Date();
            const formattedDate = summaryDatePicker.formatDate(today, "Y-m-d");
            AttandanceSummary(formattedDate);
        };

        // Modal functions
        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.toggle('show');
            }
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Print function
        function printData() {
            window.print();
        }

        // Helper functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(toast);
                setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateDashboardStats() {
            const today = new Date();
            const formattedDate = summaryDatePicker.formatDate(today, "Y-m-d");
                            AttandanceSummary(formattedDate);
                        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('search').focus();
            }
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });
    </script>
</body>

</html>
